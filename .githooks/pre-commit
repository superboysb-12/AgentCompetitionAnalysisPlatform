#!/bin/sh
# Abort commits if any newly added or modified file exceeds 100MB.

set -e

MAX_BYTES=104857600
status=0

staged_files="$(git diff --cached --name-only --diff-filter=AM)"

if [ -z "$staged_files" ]; then
  exit 0
fi

for file in $staged_files; do
  # Skip if file was deleted or missing in working tree
  if [ ! -f "$file" ]; then
    continue
  fi
  size=$(wc -c <"$file")
  if [ "$size" -ge "$MAX_BYTES" ]; then
    echo "âŒ Blocked commit: $file is $(printf '%.2f' "$(echo "$size / 1048576" | bc -l)") MB (limit 100MB)." >&2
    status=1
  fi
done

exit $status
