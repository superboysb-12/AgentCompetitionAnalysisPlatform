# 属性评估功能说明

## 更新概述

评估器已升级，现在不仅评估关系（三元组），还会评估实体的属性抽取质量。

## 新增功能

### 1. 属性支持度评估

在计算证据支持度时，现在会额外检查：
- **主体属性** (`subject_attributes`)
- **客体属性** (`object_attributes`)

#### 评估方法
- 检查属性键是否在证据文本中出现
- 检查属性值是否在证据文本中出现
- 计算匹配率作为属性支持度

#### 权重分配
新的支持度计算公式：
```
support_score = 0.5 * 语义相似度 + 0.3 * 启发式匹配 + 0.2 * 属性支持度
```

### 2. 属性统计信息

评估报告现在包含详细的属性统计：

#### 统计指标
- **主体属性覆盖率**: 有主体属性的三元组占比
- **客体属性覆盖率**: 有客体属性的三元组占比
- **平均主体属性数**: 每个三元组平均抽取的主体属性数量
- **平均客体属性数**: 每个三元组平均抽取的客体属性数量

#### 输出位置
- 控制台摘要输出
- Markdown 评估报告
- JSON 详细结果文件

## 使用示例

### 数据格式要求

三元组数据应包含 `subject_attributes` 和 `object_attributes` 字段：

```json
{
  "subject": "美的观酷",
  "subject_type": "系列",
  "subject_attributes": {
    "系列特色": "智能控制"
  },
  "relation": "属于品牌",
  "object": "美的",
  "object_type": "品牌",
  "object_attributes": {},
  "confidence": 0.95,
  "evidence": "美的观酷系列采用智能控制技术",
  "evidence_spans": [...]
}
```

### 运行评估

```bash
cd LLMRelationExtracter
python scripts/quality_check/run_quality_check.py
```

### 评估输出示例

```
【gemini-2.5-flash】评估摘要:
  三元组总数: 1000
  平均支持度: 0.782 (±0.123)
  平均一致性: 0.856 (±0.098)
  平均综合质量: 0.809
  质量分布:
    高质量(≥0.7): 750 (75.0%)
    中等质量(0.4-0.7): 200 (20.0%)
    低质量(<0.4): 50 (5.0%)
  属性统计:
    主体属性覆盖率: 85.0% (850/1000)
    客体属性覆盖率: 60.0% (600/1000)
    平均主体属性数: 2.34
    平均客体属性数: 1.56
```

## 技术细节

### 属性匹配阈值
- 属性键匹配阈值: 70（模糊匹配分数）
- 属性值匹配阈值: 70（模糊匹配分数）

### 特殊处理
- 如果三元组没有任何属性，属性支持度默认为 1.0（满分）
- 属性匹配使用模糊匹配（支持字符串相似度匹配）

## 向后兼容性

- ✅ 旧格式数据（没有 `subject_attributes`/`object_attributes` 字段）仍可正常评估
- ✅ 属性字段缺失时会使用空字典 `{}`
- ✅ 所有原有功能保持不变

## 修改的文件

- `scripts/quality_check/triple_quality_checker.py` - 核心评估逻辑
  - `compute_support_score()` - 添加属性参数
  - `_compute_attribute_support()` - 新增属性支持度计算方法
  - `evaluate_single_kg()` - 添加属性统计
  - `_print_kg_summary()` - 添加属性统计输出
  - `generate_quality_report()` - 在报告中包含属性统计

## 下一步改进建议

1. **属性质量分级**: 可以根据属性覆盖率对模型进行分级
2. **属性类型分析**: 统计不同类型属性的抽取效果
3. **属性完整性检查**: 对比 schema 定义，检查必需属性是否被抽取
4. **属性准确性验证**: 验证数值型属性的单位和范围是否合理

## 常见问题

**Q: 为什么属性支持度权重只有 0.2？**
A: 关系本身是三元组的核心，属性是补充信息。0.2 的权重既能反映属性质量，又不会过度影响整体评分。

**Q: 如何提高属性覆盖率？**
A: 在提示词中强调属性抽取的重要性，并提供更多包含属性的 few-shot 示例。

**Q: 属性为空字典 {} 和没有属性字段有区别吗？**
A: 没有区别，两者都会被识别为无属性，属性支持度都是 1.0。
